<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXA Exam - Ujian Online</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ======================================================= */
        /* 1. BASE STYLING (SAMA DENGAN QUIZ.HTML)                 */
        /* ======================================================= */
        html, body { height: 100%; }
        body { 
            font-family: 'Poppins', sans-serif;
            margin: 0; padding: 0; 
            background: linear-gradient(135deg, #a7b7eb 0%, #7d8be0 100%) !important;
            min-height: 100vh; 
            display: flex; 
            justify-content: center;
            align-items: center;
            overflow-y: auto; 
            position: relative;
        }
        
        /* Layer 5 Background */
        body.digital-paper-bg {
          background: linear-gradient(90deg, rgba(252, 252, 247, 1) 20%, rgba(138, 194, 237, 1) 100%) !important;
        }

        .container { 
            max-width: 850px; width: 90%; margin: 2rem auto; padding: 2.5rem; 
            background: rgba(255, 255, 255, 0.7); 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3); 
            position: relative;
        }
        
        .container.quiz-mode {
            max-width: 1100px; width: 95%; padding: 1.5rem; 
        }

        /* Logo & Headers */
        .nexa-text-logo {
            background-color: #D3F1EE; border-radius: 12px; padding: 15px 30px;
            margin: 0 auto 10px auto; display: inline-block; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .nexa-text-logo h2.logo-text {
            color: #2C6367; font-size: 1.8em; margin: 0; font-weight: 700; letter-spacing: 1.5px;
        }
        .nexa-text-logo p.slogan {
            color: #3C8388; font-size: 0.9em; margin: -5px 0 0 0; font-weight: 400;
        }

        /* Layer 4 Styles */
        #quizNameDisplay { text-align: center; font-size: 1.6em; font-weight: 700; color: #34495e; margin: 15px 0 25px 0; }
        .layer4-subheader { text-align: center; margin-bottom: 25px; }
        .layer4-subheader .japanese-label { font-size: 1.6em; font-weight: 600; color: #2c3e50; margin: 0; }
        
        /* Inputs */
        .form-input-wrapper { position: relative; margin-bottom: 15px; }
        .form-input-wrapper .icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .form-input { width: 100%; padding: 12px 15px 12px 45px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.4); background: rgba(255,255,255,0.9); box-sizing: border-box; }
        
        /* Buttons */
        button { padding: 14px 20px; margin-top: 15px; border-radius: 10px; font-weight: 600; border: none; color: #fff; background: #5b7efc; width: 100%; cursor: pointer; transition: all 0.3s; }
        button:hover:not(:disabled) { background: #4a6fe0; transform: translateY(-1px); }
        button:disabled { background: #cccccc; cursor: not-allowed; opacity: 0.7; }

        /* ======================================================= */
        /* 2. EXAM LAYOUT (LAYER 6)                                */
        /* ======================================================= */
        :root {
            --l6-bg-panel: #FFFFFF; --l6-bg-main: #f4f7f6; --l6-border-color: #E0E0E0;
            --l6-primary-color: #4A90E2; 
        }

        .quiz-layout-container {
            display: grid; grid-template-rows: auto 1fr auto; width: 100%; min-height: 75vh;
            background: var(--l6-bg-main); border-radius: 8px; overflow: hidden; border: 1px solid var(--l6-border-color);
        }

        /* Header */
        #l6-header { padding: 12px 20px; background: #fff; border-bottom: 1px solid var(--l6-border-color); }
        .header-info { display: flex; justify-content: space-between; font-weight: 600; }
        .progress-bar-container { height: 8px; background: #E0E0E0; margin-top: 10px; border-radius: 4px; overflow: hidden; }
        #l6-progress-bar { height: 100%; background: var(--l6-primary-color); width: 0%; transition: width 0.3s ease; }

        /* Main Area (2 Columns) */
        #l6-main { display: grid; grid-template-columns: 150px 1fr; overflow-y: auto; }

        /* Left Panel (Nav) */
        #l6-nav-panel { background: #fff; border-right: 1px solid var(--l6-border-color); padding: 15px; overflow-y: auto; }
        #l6-question-list-nav { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 10px; }
        #l6-question-list-nav li {
            width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            border: 1px solid var(--l6-border-color); cursor: pointer; font-weight: 600; background: #f0f0f0;
        }

        /* Nav Colors */
        .nav-q-unanswered { background: #f0f0f0; color: #555; }
        .nav-q-active { background: var(--l6-primary-color) !important; color: #fff !important; transform: scale(1.1); }
        .nav-q-answered { background: #2ECC71; border-color: #27ae60; color: #fff; }
        .nav-q-skipped { background: #F39C12; border-color: #e67e22; color: #fff; }

        /* Right Panel (Question) */
        #l6-question-panel { padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* Typography Soal */
        .question-title { display: flex; align-items: baseline; font-size: 1.3rem; margin-bottom: 25px; line-height: 1.5; }
        .q-number-display { 
            width: 32px; height: 32px; border-radius: 50%; background: var(--l6-primary-color); color: #fff;
            display: inline-flex; justify-content: center; align-items: center; margin-right: 12px; flex-shrink: 0;
        }
        .question-text-wrapper { line-height: 2.2; width: 100%; }
        
        /* Furigana Styling (PENTING) */
        ruby { display: inline-flex; flex-direction: column-reverse; vertical-align: bottom; align-items: center; margin: 0 2px; }
        rt { display: block; font-size: 0.55em; line-height: 1; text-align: center; margin-bottom: -8px; transform: translateY(2px); color: #555; user-select: none; }

        /* Options */
        .options-container { display: flex; flex-direction: column; gap: 12px; }
        .option-label { 
            display: block; background: #fff; border: 1px solid #ddd; padding: 12px 15px; 
            border-radius: 8px; cursor: pointer; width: 100%; box-sizing: border-box;
        }
        .option-label:hover { background: #f7f9fc; border-color: var(--l6-primary-color); }
        .option-label input[type="radio"] { margin-right: 12px; transform: scale(1.1); }
        .option-label input[type="radio"]:checked + span { font-weight: 600; color: #1e40af; }
        .option-label:has(input[type="radio"]:checked) { background: #e0f2fe; border-color: var(--l6-primary-color); }

        /* Footer */
        #l6-footer { padding: 15px 20px; background: #fff; border-top: 1px solid var(--l6-border-color); display: flex; justify-content: space-between; align-items: center; }
        #l6-timer { font-weight: 600; font-size: 1.2rem; color: #D9534F; }

        /* Buttons Bottom */
        #l6-question-nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        #l6-question-nav-buttons button { width: auto; }
        #l6-btn-skip { background: #f39c12; }
        #l6-btn-skip:hover { background: #e67e22; }

        /* REVIEW PAGE FIXES (FIX FURIGANA BERTUMPUK) */
        .review-question-container { padding-bottom: 30px; margin-bottom: 30px; border-bottom: 2px dashed #eee; }
        
        /* Paksa Ruby di review agar tetap rapi */
        .review-question-container ruby { 
            display: inline-flex !important; 
            flex-direction: column-reverse !important; 
            vertical-align: bottom !important;
        }
        .review-question-container rt {
            display: block !important;
            margin-bottom: -8px !important;
        }

        .option-label-review { 
            display: flex !important; align-items: baseline; width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; opacity: 0.8;
        }
        .option-label-review span { display: inline-block; margin-left: 8px; line-height: 2.2; }
        
        .review-correct { background: #e6f7ec !important; border-color: #2ECC71 !important; opacity: 1 !important; font-weight: 600; }
        .review-incorrect { background: #fdeeee !important; border-color: #D9534F !important; opacity: 1 !important; text-decoration: line-through; }

        /* UTILS */
        .hidden { display: none !important; }
        .error { color: #e74c3c; font-weight: bold; }

        /* INTRO CARD (Layer 5) */
        .intro-card { background: #FCFCF7; border-radius: 12px; padding: 40px; text-align: center; max-width: 600px; margin: auto; }
        .l5-header-box { border: 2px solid #333; padding: 10px; display: inline-block; margin-bottom: 20px; background: #fff; }
        .start-btn { background: #4A90E2; color: #fff; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; }
        
        /* RESPONSIVE */
        @media (max-width: 800px) {
            #l6-main { grid-template-columns: 1fr; }
            #l6-nav-panel { border-right: none; border-bottom: 1px solid #ccc; overflow-x: auto; padding: 10px; }
            #l6-question-list-nav { flex-direction: row; }
            .container { padding: 10px; width: 100%; }
            #l6-header, #l6-footer { flex-direction: column; align-items: flex-start; gap: 10px; }
            #l6-btn-submit-category { width: 100%; }
        }
    </style>
</head>

<body>
    <div class="container">
        
        <div style="text-align: center; margin-bottom: 20px;">
            <div class="nexa-text-logo">
                <h2 class="logo-text">[EXAM MODE]</h2>
                <p class="slogan">Official Examination Portal</p>
            </div>
        </div>

        <div id="layer4"> 
            <p id="quizNameDisplay"></p>
            <div class="layer4-subheader">
                <h2 class="japanese-label">ÂèóÈ®ìËÄÖË™çË®º</h2>
                <p class="english-label">Candidate Authentication</p>
            </div>
            
            <div id="tokenInputArea" class="form-group hidden">
                <div class="form-input-wrapper">
                    <i class="fas fa-key icon"></i>
                    <input type="text" id="tokenInput" class="form-input" placeholder="Masukkan token ujian Anda" /> 
                </div>
                <button id="btnValidateToken">Verifikasi Token</button>
            </div>
        </div>

        <div id="layer5" class="hidden">
          <div class="intro-card">
            <div class="l5-header-box">
                <h3 style="margin:0; font-size:1.5rem;">OFFICIAL EXAM</h3>
            </div>

            <h2 class="l5-hello">Selamat Datang, <span id="welcomeUserName">Peserta</span></h2>

            <p class="l5-main-info">
                Anda akan memulai ujian <b><span id="testInfoTitle">...</span></b>.
                <br>
                Ujian ini terdiri dari beberapa sesi (Knowledge, Reading, Listening).
                <br>
                <span style="color:#D9534F; font-size: 0.9em;">
                    <i class="fas fa-stopwatch"></i> Waktu berjalan akumulatif untuk semua sesi.
                </span>
            </p>

            <div class="warning-box" style="background:#fff3cd; padding:15px; border:1px solid #ffeeba; border-radius:5px; margin:20px 0;">
                <strong>‚ö†Ô∏è PERATURAN UJIAN:</strong>
                <ul style="text-align:left; font-size:0.9rem; margin-top:5px; padding-left:20px;">
                    <li>Dilarang mengunduh audio soal.</li>
                    <li>Audio listening hanya dapat diputar maksimal <b>2 kali</b>.</li>
                    <li>Tombol "Lanjut" hanya aktif jika soal sudah dijawab.</li>
                    <li>Gunakan tombol "Lewati" jika ragu.</li>
                </ul>
            </div>

            <button id="btnStartChallenge" class="start-btn">MULAI UJIAN SEKARANG</button>
            
            <p style="margin-top:20px; font-size:0.8rem; color:#777;">Exam System by NEEXA</p>
          </div>
        </div>

        <p id="message4" class="error" style="text-align: center; margin-top: 15px;"></p>

        <div id="accessContent" class="hidden">
            <div class="quiz-layout-container">
                <header id="l6-header">
                    <div class="header-info">
                        <span id="l6-product-name">Ujian</span>
                        <span id="l6-user-info">Peserta</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="l6-progress-bar" style="width: 0%;"></div>
                    </div>
                </header>

                <main id="l6-main">
                    <aside id="l6-nav-panel">
                        <div style="font-weight:600; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">Nomor Soal</div>
                        <ul id="l6-question-list-nav"></ul>
                    </aside>

                    <section id="l6-question-panel">
                        <div id="l6-question-content">
                            <div id="loadingMsg" style="text-align:center; padding:20px;">Memuat Soal...</div>
                        </div>
                        
                        <div id="l6-question-nav-buttons" class="hidden">
                            <button id="l6-btn-back">‚¨ÖÔ∏è Kembali</button>
                            <button id="l6-btn-skip" style="background:#f39c12;">üîÅ Lewati</button>
                            <button id="l6-btn-next" disabled style="opacity:0.6;">Lanjut ‚û°Ô∏è</button>
                        </div>
                    </section>
                </main>

                <footer id="l6-footer">
                    <span id="l6-timer">Waktu Tersisa: --:--</span>
                    <button id="l6-btn-submit-category" class="hidden" style="background:#27ae60;">Selesai Sesi Ini</button>
                </footer>
            </div>
        </div> 

        <div id="layer-review-page" class="hidden"></div>

        <button type="button" id="btnBackToGateway" onclick="window.location.href='index.html'" style="margin-top: 30px; display:block; margin-left:auto; margin-right:auto; width:200px;">Kembali ke Utama</button>
        
    </div>

<script>
    // --- KONFIGURASI ---
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzXuJmMUYmCgf-C3O0HKQ7iT3NIgs1_aRmhA9r6jPpF8SoNmjIyONQmw5979l2bdbOVNQ/exec";
    let API_KEY = 'RLNE14EXA10SALE0125'; 
    const urlParams = new URLSearchParams(window.location.search);
    let currentDeviceID = localStorage.getItem('NEXA_DEVICE_ID');
    let currentProduct = urlParams.get('product') || '';
    let USER_DATA = {}; 
    const OPTIONS_KEYS = ['A', 'B', 'C', 'D']; 

    // --- GLOBAL STATE ---
    let quizState = {
        currentCategory: null,   
        currentQuestionIndex: -1, 
        questions: [],            
        questionStates: {},     
    };

    // Global Timer State
    let globalTimer = {
        totalSeconds: 0,
        intervalId: null,
        isRunning: false
    };

    // Audio Restriction State
    let audioPlayCounts = {}; // { 'q_ID': 0, 'q_ID2': 1 }

    // Store Score
    let finalScoreReport = { 'knowledge': null, 'reading': null, 'listening': null };
    let reviewDataStore = {}; 
    let allQuestionsStore = {}; 

    // UI Elements
    const UI = {
        msg4: document.getElementById('message4'), 
        tokenInputArea: document.getElementById('tokenInputArea'),
        inputToken: document.getElementById('tokenInput'),
        btnValidateToken: document.getElementById('btnValidateToken'),
        layer4: document.getElementById('layer4'),
        layer5: document.getElementById('layer5'),
        btnStartChallenge: document.getElementById('btnStartChallenge'),
        accessContent: document.getElementById('accessContent'),
        l6Header: document.getElementById('l6-header'),
        l6Main: document.getElementById('l6-main'),
        l6NavPanel: document.getElementById('l6-nav-panel'),
        l6QuestionListNav: document.getElementById('l6-question-list-nav'), 
        l6QuestionContent: document.getElementById('l6-question-content'),
        l6QuestionNavButtons: document.getElementById('l6-question-nav-buttons'),
        l6BtnBack: document.getElementById('l6-btn-back'),
        l6BtnSkip: document.getElementById('l6-btn-skip'),
        l6BtnNext: document.getElementById('l6-btn-next'),
        l6Timer: document.getElementById('l6-timer'),
        l6BtnSubmitCategory: document.getElementById('l6-btn-submit-category'),
        layerReviewPage: document.getElementById('layer-review-page'),
        l6ProgressBar: document.getElementById('l6-progress-bar'),
        l6ProductName: document.getElementById('l6-product-name'),
        l6UserInfo: document.getElementById('l6-user-info')
    };

    // --- API UTILS ---
    async function apiCall(action, payload = {}) {
        document.body.style.cursor = 'wait';
        try {
            const res = await fetch(GAS_API_URL, {
                method: "POST", headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ action, payload })
            });
            document.body.style.cursor = 'default';
            return await res.json();
        } catch (e) {
            document.body.style.cursor = 'default';
            alert("Koneksi Error"); return { success: false };
        }
    }

    function setMessage(el, msg, success) {
        el.className = success ? 'success' : 'error'; el.textContent = msg;
    }
    function convertFuriganaToRuby(text) {
        if (!text) return "";
        return text.replace(/([‰∏Ä-ÈæØ„ÅÅ-„Çì„Ç°-„É≥]+?)\[([„ÅÅ-„Çì„Ç°-„É≥]+?)\]/g, '<ruby>$1<rt>$2</rt></ruby>');
    }

    // --- INIT & VALIDASI ---
    document.addEventListener('DOMContentLoaded', () => {
        if(!currentDeviceID) {
            currentDeviceID = 'DEV-' + Math.random().toString(36).substring(2,10);
            localStorage.setItem('NEXA_DEVICE_ID', currentDeviceID);
        }
        
        const tokenFromURL = urlParams.get('token');
        if (tokenFromURL) {
            UI.inputToken.value = tokenFromURL;
            UI.tokenInputArea.classList.add('hidden');
            validateToken(tokenFromURL);
        } else {
            UI.tokenInputArea.classList.remove('hidden');
        }

        UI.btnValidateToken.addEventListener('click', () => validateToken(UI.inputToken.value.trim()));
        
        UI.btnStartChallenge.addEventListener('click', () => {
            UI.layer5.classList.add('hidden');
            UI.accessContent.classList.remove('hidden');
            document.querySelector('.container').classList.add('quiz-mode');
            // MULAI KATEGORI PERTAMA
            startCategory('knowledge'); 
        });
    });

    function validateToken(token) {
        setMessage(UI.msg4, "Validasi...", true);
        apiCall('validateAccess', { apiKey: API_KEY, token, deviceID: currentDeviceID })
            .then(res => {
                if(res.success) {
                    USER_DATA = res.data;
                    document.getElementById('welcomeUserName').textContent = USER_DATA.nama;
                    document.getElementById('testInfoTitle').textContent = USER_DATA.product;
                    UI.layer4.classList.add('hidden');
                    UI.layer5.classList.remove('hidden');
                    setMessage(UI.msg4, "", true);
                } else {
                    setMessage(UI.msg4, res.message, false);
                    UI.tokenInputArea.classList.remove('hidden');
                }
            });
    }

    // --- GLOBAL TIMER LOGIC (NEW) ---
    function startGlobalExamTimer(minutes) {
        if (globalTimer.isRunning) return; // Jangan restart jika sudah jalan
        
        console.log(`üïí Memulai Global Timer: ${minutes} menit`);
        globalTimer.totalSeconds = minutes * 60;
        globalTimer.isRunning = true;
        UI.l6Timer.classList.remove('hidden');

        globalTimer.intervalId = setInterval(() => {
            globalTimer.totalSeconds--;
            
            const m = Math.floor(globalTimer.totalSeconds / 60);
            const s = globalTimer.totalSeconds % 60;
            UI.l6Timer.textContent = `Waktu Tersisa: ${m}:${s < 10 ? '0'+s : s}`;

            if (globalTimer.totalSeconds <= 0) {
                clearInterval(globalTimer.intervalId);
                UI.l6Timer.textContent = "WAKTU HABIS!";
                alert("Waktu Habis! Ujian akan dikumpulkan otomatis.");
                submitCategory(); // Submit kategori saat ini, lalu sistem akan lanjut/selesai
            }
        }, 1000);
    }

    // --- CATEGORY & QUESTION LOGIC ---
    function startCategory(cat) {
        quizState.currentCategory = cat;
        UI.l6QuestionContent.innerHTML = `<div style="text-align:center; padding:20px;">Memuat soal ${cat}...</div>`;
        UI.l6QuestionNavButtons.classList.add('hidden');

        apiCall('getQuizQuestions', { apiKey: API_KEY, category: cat, product: currentProduct })
            .then(res => {
                if(res.success) {
                    quizState.questions = res.data.questions;
                    quizState.questionStates = {};
                    quizState.currentQuestionIndex = 0;
                    allQuestionsStore[cat] = quizState.questions; // Simpan untuk review

                    // INISIALISASI STATUS SOAL
                    quizState.questions.forEach(q => {
                        quizState.questionStates[q.id] = { status: 'unanswered', answer: null };
                    });
                    
                    // --- GLOBAL TIMER START (Hanya di kategori pertama/saat belum jalan) ---
                    // Mengambil waktu dari sheet (misal di kategori Knowledge ada setting waktu)
                    // Kita asumsikan waktu di Knowledge berlaku Global.
                    if (res.data.timeLimit > 0 && !globalTimer.isRunning) {
                        startGlobalExamTimer(res.data.timeLimit);
                    }

                    renderCurrentView();
                    renderNavPanel();
                    UI.l6QuestionNavButtons.classList.remove('hidden');
                    updateHeader();
                } else {
                    alert("Gagal memuat soal: " + res.message);
                }
            });
    }

    function updateHeader() {
        UI.l6ProductName.textContent = currentProduct;
        UI.l6UserInfo.textContent = `${USER_DATA.nama} - ${quizState.currentCategory.toUpperCase()}`;
        
        // Progress Bar
        const total = quizState.questions.length;
        const answered = Object.values(quizState.questionStates).filter(s => s.status === 'answered').length;
        UI.l6ProgressBar.style.width = `${(answered/total)*100}%`;
    }

    // --- RENDER SOAL (UPDATED: AUDIO RESTRICTION & BUTTON LOGIC) ---
    function renderCurrentView() {
        const index = quizState.currentQuestionIndex;
        const q = quizState.questions[index];
        const qState = quizState.questionStates[q.id];

        // 1. Audio / Gambar
        let mediaHtml = '';
        if (q.mediaUrl) {
            if (quizState.currentCategory === 'listening') {
                // AUDIO RESTRICTION LOGIC
                // Kita tambahkan ID unik agar bisa di-track
                mediaHtml = `
                    <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #ddd;">
                        <p style="font-size:0.8rem; margin:0 0 5px 0; color:#d9534f;"><i class="fas fa-exclamation-circle"></i> Audio max putar: 2x</p>
                        <audio id="audio_${q.id}" controls controlsList="nodownload" oncontextmenu="return false" style="width: 100%;">
                            <source src="${q.mediaUrl}" type="audio/mpeg">
                        </audio>
                    </div>`;
            } else {
                mediaHtml = `<img src="${q.mediaUrl}" style="max-width:100%; border-radius:5px; margin-bottom:15px;">`;
            }
        }

        // 2. Teks Soal
        let processedText = convertFuriganaToRuby(q.questionText);
        if (processedText.includes(':')) {
            const parts = processedText.split(':', 2);
            processedText = `${parts[0]}:<br><span style="display:block;margin-top:5px;">${parts[1]}</span>`;
        }
        
        let contentHtml = `<h3 class="question-title"><span class="q-number-display">${index+1}</span> <div class="question-text-wrapper">${processedText}</div></h3>`;
        if (q.passageText) contentHtml = `<div style="background:#f9f9f9; padding:15px; border:1px solid #eee; margin-bottom:20px;">${convertFuriganaToRuby(q.passageText)}</div>` + contentHtml;

        // 3. Opsi Jawaban
        let optionsHtml = '<div class="options-container">';
        OPTIONS_KEYS.forEach(key => {
            const optText = q.options[key];
            if(optText) {
                const isChecked = (qState.answer === key) ? 'checked' : '';
                const disp = optText.startsWith('http') ? `<img src="${optText}" style="height:60px;">` : convertFuriganaToRuby(optText);
                
                optionsHtml += `
                    <label class="option-label">
                        <input type="radio" name="q_${q.id}" value="${key}" ${isChecked} onchange="saveAnswer('${q.id}', '${key}')">
                        <span>${key}. ${disp}</span>
                    </label>`;
            }
        });
        optionsHtml += '</div>';

        UI.l6QuestionContent.innerHTML = contentHtml + mediaHtml + optionsHtml;

        // 4. SETUP AUDIO LISTENER (SETELAH RENDER)
        if (q.mediaUrl && quizState.currentCategory === 'listening') {
            const audioEl = document.getElementById(`audio_${q.id}`);
            if (audioEl) {
                // Cek count
                if (!audioPlayCounts[q.id]) audioPlayCounts[q.id] = 0;
                
                audioEl.addEventListener('play', () => {
                    if (audioPlayCounts[q.id] >= 2) {
                        audioEl.pause();
                        audioEl.currentTime = 0;
                        alert("Batas pemutaran audio (2x) telah habis!");
                    } else {
                        audioPlayCounts[q.id]++;
                    }
                });
            }
        }

        // 5. UPDATE BUTTON STATE (REVISI: NEXT BUTTON)
        UI.l6BtnBack.disabled = (index === 0);
        const isLast = (index === quizState.questions.length - 1);
        UI.l6BtnNext.classList.toggle('hidden', isLast);
        UI.l6BtnSubmitCategory.classList.toggle('hidden', !isLast);

        // LOGIKA TOMBOL NEXT: Mati jika belum dijawab
        // Kecuali jika statusnya 'skipped', kita anggap user boleh lanjut (karena sudah lewat tombol skip)
        // Tapi tombol Next ini fungsinya "Jawab & Lanjut".
        const hasAnswer = (qState.status === 'answered');
        UI.l6BtnNext.disabled = !hasAnswer; 
        if (hasAnswer) {
            UI.l6BtnNext.style.opacity = '1';
            UI.l6BtnNext.style.cursor = 'pointer';
        } else {
            UI.l6BtnNext.style.opacity = '0.6';
            UI.l6BtnNext.style.cursor = 'not-allowed';
        }
    }

    function saveAnswer(qId, val) {
        // Simpan
        quizState.questionStates[qId].status = 'answered';
        quizState.questionStates[qId].answer = val;
        
        // Update Nav Color (Hijau)
        const idx = quizState.questions.findIndex(q => q.id == qId);
        const navLi = UI.l6QuestionListNav.children[idx];
        if(navLi) navLi.className = 'nav-q-answered';

        // Aktifkan Tombol Next
        UI.l6BtnNext.disabled = false;
        UI.l6BtnNext.style.opacity = '1';
        UI.l6BtnNext.style.cursor = 'pointer';

        updateHeader();
    }

    function renderNavPanel() {
        UI.l6QuestionListNav.innerHTML = '';
        quizState.questions.forEach((q, idx) => {
            const li = document.createElement('li');
            li.textContent = idx + 1;
            // Class berdasarkan status (active/answered/skipped/unanswered)
            const st = quizState.questionStates[q.id].status;
            li.className = (idx === quizState.currentQuestionIndex) ? 'nav-q-active' : `nav-q-${st}`;
            
            li.addEventListener('click', () => {
                quizState.currentQuestionIndex = idx;
                renderCurrentView();
                renderNavPanel(); // Refresh active state
            });
            UI.l6QuestionListNav.appendChild(li);
        });
    }

    // --- LISTENERS TOMBOL NAVIGASI ---
    UI.l6BtnNext.addEventListener('click', () => {
        // Cek lagi (double protection)
        const currQ = quizState.questions[quizState.currentQuestionIndex];
        if (quizState.questionStates[currQ.id].status !== 'answered') {
            alert("Silakan jawab soal ini atau tekan tombol 'Lewati'!");
            return;
        }
        quizState.currentQuestionIndex++;
        renderCurrentView();
        renderNavPanel();
    });

    UI.l6BtnBack.addEventListener('click', () => {
        quizState.currentQuestionIndex--;
        renderCurrentView();
        renderNavPanel();
    });

    UI.l6BtnSkip.addEventListener('click', () => {
        const idx = quizState.currentQuestionIndex;
        const qId = quizState.questions[idx].id;
        
        // Set status Skipped
        quizState.questionStates[qId].status = 'skipped';
        quizState.questionStates[qId].answer = null; // Reset jawaban jika ada
        
        // Pindah soal
        if (idx < quizState.questions.length - 1) {
            quizState.currentQuestionIndex++;
            renderCurrentView();
        } else {
            // Jika soal terakhir di-skip
            renderNavPanel();
            renderCurrentView(); // Refresh view
        }
    });

    UI.l6BtnSubmitCategory.addEventListener('click', () => submitCategory());

    // --- SUBMIT & TRANSISI ---
    function submitCategory() {
        const cat = quizState.currentCategory;
        const payload = {
            apiKey: API_KEY,
            email: USER_DATA.email,
            phone: USER_DATA.phone,
            product: currentProduct,
            category: cat,
            answers: quizState.questionStates
        };

        UI.l6QuestionContent.innerHTML = `<div style="text-align:center; padding:30px;"><h3>Menyimpan Jawaban...</h3></div>`;
        UI.l6QuestionNavButtons.classList.add('hidden');

        apiCall('submitCategoryAnswers', payload).then(res => {
            if(res.success) {
                // LOGIKA TRANSISI GLOBAL TIMER
                // Jangan stop timer global!
                
                // Simpan Score
                finalScoreReport[cat] = res.data;
                if(res.data.details) reviewDataStore[cat] = res.data.details;

                // Cek Next Category
                let nextCat = null;
                if(cat === 'knowledge') nextCat = 'reading';
                else if(cat === 'reading') nextCat = 'listening';

                if(nextCat) {
                    setTimeout(() => startCategory(nextCat), 1000);
                } else {
                    // SELESAI SEMUA
                    if(globalTimer.intervalId) clearInterval(globalTimer.intervalId); // Stop Timer
                    renderFinalScorePage();
                }
            } else {
                alert("Gagal submit: " + res.message);
                renderCurrentView(); // Balikin view
            }
        });
    }

    // --- HALAMAN REVIEW ---
    function renderFinalScorePage() {
        UI.accessContent.classList.add('hidden');
        UI.layerReviewPage.classList.remove('hidden');

        let html = `<div id="l6-final-score-page"><h2>Hasil Ujian</h2><ul class="score-details">`;
        let totalP = 0, totalMax = 0;

        ['knowledge', 'reading', 'listening'].forEach(cat => {
            const rep = finalScoreReport[cat];
            if(rep) {
                totalP += rep.points; totalMax += rep.maxPoints;
                html += `<li><button class="review-btn" onclick="showReview('${cat}')">
                         <strong>${cat.toUpperCase()}:</strong> ${rep.points}/${rep.maxPoints} 
                         <span class="review-btn-text">Lihat Review</span></button></li>`;
            }
        });

        const finalPerc = totalMax > 0 ? (totalP/totalMax)*100 : 0;
        const status = finalPerc >= 80 ? 
            `<div class="status-lulus">LULUS (${finalPerc.toFixed(1)}%)</div>` : 
            `<div class="status-gagal">TIDAK LULUS (${finalPerc.toFixed(1)}%)</div>`;

        html += `</ul>${status}</div>`;
        UI.layerReviewPage.innerHTML = html;
    }

    // Mode Review (Tanpa Timer, Tanpa Audio Limit)
    window.showReview = function(cat) {
        const questions = allQuestionsStore[cat];
        const details = reviewDataStore[cat];
        if(!questions || !details) return;

        UI.layerReviewPage.classList.add('hidden');
        UI.accessContent.classList.remove('hidden');
        UI.l6NavPanel.classList.add('hidden'); // Sembunyikan Nav Kiri
        UI.l6QuestionNavButtons.classList.add('hidden');
        UI.l6Timer.textContent = "REVIEW MODE";
        
        let html = '';
        questions.forEach((q, idx) => {
            const det = details[q.id];
            const uAns = det.answer;
            const cAns = det.correct;
            
            // Audio Review (Bebas Putar)
            let med = '';
            if(q.mediaUrl) {
                if(cat==='listening') med = `<audio controls src="${q.mediaUrl}" style="width:100%"></audio>`;
                else med = `<img src="${q.mediaUrl}" style="max-width:100%">`;
            }

            let opts = '<div class="options-container">';
            OPTIONS_KEYS.forEach(k => {
                const txt = q.options[k];
                if(txt) {
                    let cls = 'option-label-review';
                    if(k === cAns) cls += ' review-correct'; // Hijau
                    if(k === uAns && k !== cAns) cls += ' review-incorrect'; // Merah Coret
                    
                    opts += `<div class="${cls}">
                                <span>${k}.</span>
                                <span>${convertFuriganaToRuby(txt)}</span>
                             </div>`;
                }
            });
            opts += '</div>';

            html += `<div class="review-question-container">
                        <h4>No. ${idx+1}</h4>
                        ${med}
                        <div style="margin:10px 0;">${convertFuriganaToRuby(q.questionText)}</div>
                        ${opts}
                     </div>`;
        });

        html += `<button onclick="renderFinalScorePage()" style="margin:20px 0; background:#555; color:#fff; width:100%; padding:15px;">Kembali ke Skor</button>`;
        
        UI.l6QuestionContent.innerHTML = html;
    };
</script>
</body>
</html>
